<script type="text/javascript">
var OBJ_LIST = ['pc','pcPolicy']
var ORIGINAL_OBJ_DATA = {}
var MODIFIED_OBJ_DATA = {}
var INFO_LIST = ['hosts']
var INFO_DATA = {};
var spec_time = ["12:30","1:00","1:30","2:00","2:30","3:00","3:30","4:00","4:30","5:00","5:30","6:00","6:30","7:00","7:30","8:00","8:30","9:00","9:30","10:00","10:30","11:00","11:30"];
var schedule_type;
var MAX_DEV_NUM = 5;
</script>
<form id='ui-form'>
<table class="table table-info parental_control_enable_zone">
<tbody>
<tr id="tr_parental_enable" >
<td><script>draw_checkbox('parental_enable', 'lang_parental_enable_title', 'on', "set_parental_controls_enable()");</script><span id="checkbox_div_parental_enable"></span>
</td>
</tr>
</tbody>
</table>
<div class="table-title target_dev_zone">
<span class="multi_lang" id="lang_parental_control_zone_target_dev_title"></span>
</div>
<hr class="table-title-underline target_dev_zone">
<table class="table table-info target_dev_zone">
<tbody>
<tr id="tr_restrict_internet_access" >
<td>
<span class="multi_lang" id="lang_restrict_internet_access_title"></span>
</td>
<td id="select_td">
<select style="width:60%" size="7" id="restrict_internet_access" name="restrict_internet_access" onchange=";update_selected(this.name);device_selected(this.index,this.value)"></select>
</td>
</tr>
<tr id="tr_dev_setting">
<td>
<span >&nbsp;</span>
</td>
<td>
<button class="btn multi_lang logger_bot" type="button" name="" id="lang_dev_add_button" onclick="displayPopout('parental_controls_dev_list');"></button>
<button class="btn multi_lang logger_bot" type="button" name="" id="lang_dev_remove_button" onclick="remove_dev_click()"></button>
<button class="btn multi_lang logger_bot" type="button" name="" id="lang_dev_rename_button" onclick="displayPopout('parental_controls_dev_rename');"></button>
</td>
</tr>
</tbody>
</table>
<div class="table-title schedule_zone">
<span class="multi_lang" id="lang_parental_control_zone_schedule_title"></span>
</div>
<hr class="table-title-underline schedule_zone">
<table class="table table-info schedule_zone">
<tbody>
<tr>
<td>
<span class="multi_lang" id="lang_block_internet_access_title"></span>
</td>
<td>
<table>
<tbody>
<tr id="tr_schedule">
<td colspan="4">
<div class="radio">
<span class="radio_0">
<input type="radio" id="schedule_never" name="schedule_radio_group" value="0" onclick="set_schedule_type(this.value)" class="logger_bot">
</span>
</div>
<span class="multi_lang radiostd" id="lang_schedule_never_title"></span>
<div class="radio">
<span class="radio_1">
<input type="radio" id="schedule_always" name="schedule_radio_group" value="1" onclick="set_schedule_type(this.value)" class="logger_bot">
</span>
</div>
<span class="multi_lang radiostd" id="lang_schedule_always_title"></span>
<div class="radio">
<span class="radio_2">
<input type="radio" id="schedule_spec_time" name="schedule_radio_group" value="2" onclick="set_schedule_type(this.value)" class="logger_bot">
</span>
</div>
<span class="multi_lang radiostd" id="lang_schedule_spec_time_title"></span>
</td>
</tr>
<tr id="tr_school_nights">
<td style="padding:5px;">
<span class="multi_lang" id="lang_school_nights_start_title"></span>
</td>
<td>
<div id="select_div_school_nights_start"></div>
</td>
<td>
<span class="multi_lang" id="lang_school_nights_end_title"></span><span >&nbsp;</span>
</td>
<td>
<div id="select_div_school_nights_end"></div>
</td>
</tr>
<tr id="tr_weekends">
<td style="padding:5px;">
<span class="multi_lang" id="lang_weekends_start_title"></span>
</td>
<td>
<div id="select_div_weekends_start"></div>
</td>
<td>
<span class="multi_lang" id="lang_weekends_end_title"></span><span >&nbsp;</span>
</td>
<td>
<div id="select_div_weekends_end"></div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<div class="table-title block_spec_sites_zone">
<span class="multi_lang" id="lang_parental_control_zone_block_spec_sites_title"></span>
</div>
<hr class="table-title-underline block_spec_sites_zone">
<table class="table table-info block_spec_sites_zone">
<tbody>
<tr id="tr_block_url1" >
<td>
<span class="multi_lang" id="lang_block_url1_title"></span>
<input maxlength="32" value="" name="block_url1" id="block_url1" onblur="valid_name(this,'URL',SPACE_NO)" size="17" class="logger_bot">
</td>
</tr>
<tr id="tr_block_url2" >
<td>
<span class="multi_lang" id="lang_block_url2_title"></span>
<input maxlength="32" value="" name="block_url2" id="block_url2" onblur="valid_name(this,'URL',SPACE_NO)" size="17" class="logger_bot">
</td>
</tr>
<tr id="tr_block_url3" >
<td>
<span class="multi_lang" id="lang_block_url3_title"></span>
<input maxlength="32" value="" name="block_url3" id="block_url3" onblur="valid_name(this,'URL',SPACE_NO)" size="17" class="logger_bot">
</td>
</tr>
<tr id="tr_block_url4" >
<td>
<span class="multi_lang" id="lang_block_url4_title"></span>
<input maxlength="32" value="" name="block_url4" id="block_url4" onblur="valid_name(this,'URL',SPACE_NO)" size="17" class="logger_bot">
</td>
</tr>
<tr id="tr_block_url5" >
<td>
<span class="multi_lang" id="lang_block_url5_title"></span>
<input maxlength="32" value="" name="block_url5" id="block_url5" onblur="valid_name(this,'URL',SPACE_NO)" size="17" class="logger_bot">
</td>
</tr>
<tr id="tr_block_url6" >
<td>
<span class="multi_lang" id="lang_block_url6_title"></span>
<input maxlength="32" value="" name="block_url6" id="block_url6" onblur="valid_name(this,'URL',SPACE_NO)" size="17" class="logger_bot">
</td>
</tr>
<tr id="tr_block_url7" >
<td>
<span class="multi_lang" id="lang_block_url7_title"></span>
<input maxlength="32" value="" name="block_url7" id="block_url7" onblur="valid_name(this,'URL',SPACE_NO)" size="17" class="logger_bot">
</td>
</tr>
<tr id="tr_block_url8" >
<td>
<span class="multi_lang" id="lang_block_url8_title"></span>
<input maxlength="32" value="" name="block_url8" id="block_url8" onblur="valid_name(this,'URL',SPACE_NO)" size="17" class="logger_bot">
</td>
</tr>
</tbody>
</table>
</form>
<div class="form-actions">
<button class="btn btn-primary multi_lang logger_bot" id="btnSave" type="button" name="" onclick="page_save()"></button>
<button class="btncancel multi_lang logger_bot" id="btnCancel" type="button" name="" onclick="page_cancel()"></button>
</div>
<script type="text/javascript">
page_tag='parental_control_parental_control'
$(document).ready(function(){
$.lang_load("parental_control_parental_control");
$.lang_load("error_message");
page_initial()
inject_log_bot()
escape_detection();
});

function get_time_24(t) {
var t_array=t.split(":");
var hh=parseInt(t_array[0]);

if (hh < 12) {
t_array[0]=hh+12;
t=t_array[0]+':'+t_array[1];
}
return t;
}

function set_specific_time_select_opts() {
var str_start=[L.parental_control_parental_control.lang_spec_time_opt_noon];
var val_start=['12:00'];
var str_end=[];
var val_end=[];

for (var i=0; i < spec_time.length; ++i) {
str_start.push(spec_time[i]+' '+L.parental_control_parental_control.lang_spec_time_opt_pm);
val_start.push(get_time_24(spec_time[i]));

str_end.push(t=spec_time[i]+' '+L.parental_control_parental_control.lang_spec_time_opt_am);
val_end.push(spec_time[i]);
}
str_start.push(L.parental_control_parental_control.lang_spec_time_opt_midnight);
val_start.push('00:00');

// id, str, val, cb
draw_select('school_nights_start', str_start, val_start, 'callback()', '');
draw_select('school_nights_end', str_end, val_end, 'callback()', '');
draw_select('weekends_start', str_start, val_start, 'callback()', '');
draw_select('weekends_end', str_end, val_end, 'callback()', '');

set_specific_time_select_default();
}

function set_parental_controls_init(obj) {
var i,j;

if (obj.pc.PcP.enable == '1')
$("#parental_enable").attr('checked','checked');
else
$("#parental_enable").removeAttr('checked');

$('#restrict_internet_access').empty();
for (i=0; i < obj.pcPolicy.PcPolicyT.length; ++i) {
$('#restrict_internet_access').append("<option value='"+obj.pcPolicy.PcPolicyT[i].targetMac+"'>"+obj.pcPolicy.PcPolicyT[i].targetName+"</option>");
}

if (obj.pcPolicy.PcPolicyT.length > 0) {
// select index 0
$('#restrict_internet_access').val(obj.pcPolicy.PcPolicyT[0].targetMac);
set_schedule_type(obj.pcPolicy.PcPolicyT[0].blockType);

for (i=1; i <= 8; ++i) {
eval('ele_set_default(document.getElementById("block_url'+i+'"),obj.pcPolicy.PcPolicyT[0].blockUrl'+i+')');
eval('$("#block_url'+i+'").val(obj.pcPolicy.PcPolicyT[0].blockUrl'+i+')');
}
}
else {
set_schedule_type('0');
$('[name^="block_url"]').val("");
}

set_parental_controls_enable();
update_checked($("#parental_enable").attr('name'));
}

function set_specific_time_select_default() {
$('#school_nights_start').val('21:00');
$('#school_nights_end').val('7:00');
$('#weekends_start').val('00:00');
$('#weekends_end').val('7:00');

update_selected($('#school_nights_start').attr("name"));
update_selected($('#school_nights_end').attr("name"));
update_selected($('#weekends_start').attr("name"));
update_selected($('#weekends_end').attr("name"));
}

function set_specific_time_select_obj(obj) {
var index=$('#restrict_internet_access').find(":selected").index();

if (index < 0 || index >= obj.length) {
set_specific_time_select_default();
return;
}

$('#school_nights_start').val(obj[index].workdayTimeStart);
$('#school_nights_end').val(obj[index].workdayTimeStop);
$('#weekends_start').val(obj[index].weekendTimeStart);
$('#weekends_end').val(obj[index].weekendTimeStop);

update_selected($('#school_nights_start').attr("name"));
update_selected($('#school_nights_end').attr("name"));
update_selected($('#weekends_start').attr("name"));
update_selected($('#weekends_end').attr("name"));
}

function set_schedule_radios_disable(state) {
if (!state) {
$('#school_nights_start').removeAttr("disabled");
$('#school_nights_end').removeAttr("disabled");
$('#weekends_start').removeAttr("disabled");
$('#weekends_end').removeAttr("disabled");
}
else {
$('#school_nights_start').attr("disabled", "true");
$('#school_nights_end').attr("disabled", "true");
$('#weekends_start').attr("disabled", "true");
$('#weekends_end').attr("disabled", "true");
}
}

function set_all_element_disable() {
$('#restrict_internet_access').attr("disabled", "true");
$('#lang_dev_add_button').attr("disabled", "true");
$('#lang_dev_remove_button').attr("disabled", "true");
$('#lang_dev_rename_button').attr("disabled", "true");
$("[name='schedule_radio_group']").attr("disabled", "true");
$("[name='schedule_radio_group']").parent('span').addClass('disabled');
set_schedule_radios_disable(true);
$("[name^='block_url']").attr("disabled", "true");
}

function set_all_element_enable(obj) {
var conn_dev_list=INFO_DATA.hosts;
var dev_list_len=$('#restrict_internet_access option').length;

$('#restrict_internet_access').removeAttr("disabled");

if (conn_dev_list.length > 0 && dev_list_len < conn_dev_list.length && dev_list_len < MAX_DEV_NUM) {
$('#lang_dev_add_button').removeAttr("disabled");
}
else {
$('#lang_dev_add_button').attr("disabled", "true");
}

if (dev_list_len > 0) {
$('#lang_dev_remove_button').removeAttr("disabled");
$('#lang_dev_rename_button').removeAttr("disabled");
$("[name='schedule_radio_group']").removeAttr("disabled");
$("[name='schedule_radio_group']").parent('span').removeClass('disabled');
$("[name^='block_url']").removeAttr("disabled");

if ($('#schedule_spec_time').parent('span').hasClass('checked')) {
set_schedule_radios_disable(false);
}
else {
$('#schedule_never').parent('span').hasClass('checked') ?
set_schedule_type('0') : set_schedule_type('1');
set_schedule_radios_disable(true);
}
}
else {
$('#lang_dev_remove_button').attr("disabled", "true");
$('#lang_dev_rename_button').attr("disabled", "true");
$("[name='schedule_radio_group']").attr("disabled", "true");
$("[name='schedule_radio_group']").parent('span').addClass('disabled');
$("[name^='block_url']").attr("disabled", "true");
set_schedule_type("0");
set_schedule_radios_disable(true);
}
}

// device selected
function device_selected(index,mac) {
var i,j;

for (i=0; i < MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT.length; ++i) {
if (MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[i].targetMac == mac) {
set_schedule_type(MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[i].blockType);
for (j=1; j <= 8; ++j) {
eval('$("#block_url'+j+'").val(MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT['+i+'].blockUrl'+j+')');
}
break;
}
}
}

// buttons click
function add_dev_click(dev_name,mac) {
var pc_obj={};

$('#restrict_internet_access').append("<option value='"+mac+"'>"+dev_name+"</option>");
$('#restrict_internet_access').val(mac);

pc_obj.gid='0';
pc_obj.name='PcPolicyT0';
pc_obj.targetName=dev_name;
pc_obj.targetMac=mac;
pc_obj.blockType='0';
pc_obj.workdayTimeStart='21:00';
pc_obj.workdayTimeStop='7:00';
pc_obj.weekendTimeStart='00:00';
pc_obj.weekendTimeStop='7:00';
for (var i=1; i <= 8; ++i) {
eval('pc_obj.blockUrl'+i+'=""');
}
MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT.push(pc_obj);

device_selected($('#restrict_internet_access').find(":selected").index(),
$('#restrict_internet_access').find(":selected").val());
set_all_element_enable(MODIFIED_OBJ_DATA);
}
function remove_dev_click() {
var index=$('#restrict_internet_access').find(":selected").index();
var mac=$('#restrict_internet_access').find(":selected").val();

for (var i=0; i < MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT.length; ++i) {
if (MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[i].targetMac == mac) {
MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT.splice(i,1);
break;
}
}
$('#restrict_internet_access').find(":selected").remove();

// select orogin index
if (index >= $('#restrict_internet_access option').length) {
index=$('#restrict_internet_access option').length-1;
}
$('#restrict_internet_access option').eq(index).prop('selected', true);

device_selected($('#restrict_internet_access').find(":selected").index(),
$('#restrict_internet_access').find(":selected").val());
set_all_element_enable(MODIFIED_OBJ_DATA);
}
function rename_dev_click(dev_new_name) {
var mac=$('#restrict_internet_access').find(":selected").val();

for (var i=0; i < MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT.length; ++i) {
if (MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[i].targetMac == mac) {
MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[i].targetName=dev_new_name;
break;
}
}

$('#restrict_internet_access').find(":selected").text(dev_new_name);
}

// radio group checked
function set_schedule_type(schedule_type) {
$("[name='schedule_radio_group']").parent('span').removeClass('checked');
eval('var schedule_class="radio_'+schedule_type+'"');
$("."+schedule_class).addClass('checked');

this.schedule_type=schedule_type;

// 0:never, 1:always, 2:specific times
if (schedule_type == "2") {
set_schedule_radios_disable(false);
set_specific_time_select_obj(MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT);
}
else {
set_schedule_radios_disable(true);
set_specific_time_select_default();
}
}

// paranetal controls checkbox checked
function set_parental_controls_enable() {
if ($("#parental_enable").prop("checked")) {
$("#parental_enable").attr('checked','checked');
set_all_element_enable(MODIFIED_OBJ_DATA);
}
else {
$("#parental_enable").removeAttr('checked');
set_all_element_disable();
}

update_selected($('#restrict_internet_access').attr("name"));
update_selected($('#school_nights_start').attr("name"));
update_selected($('#school_nights_end').attr("name"));
update_selected($('#weekends_start').attr("name"));
update_selected($('#weekends_end').attr("name"));
}

// find & remove protocol (http, ftp, etc.) and get hostname
function extractHostname(url) {
var hostname;
var matches = url.match(/(?:\w+\:\/\/)?(?:www\.)?([^\/?#]+)(?:[\/?#]|$)/i);

hostname = matches && matches[1];  // domain will be null if no match is found

return hostname;
}

// append top-level domain for url , ex: google -> google.com
function appendTopLevelDomain(url) {
var hostname;

if (typeof(url) == 'undefined' || url === null)
return null;

// remove first and last '.'
hostname = url.replace(/^\.?|\.?$/g, "");
if (typeof(hostname) == 'undefined' || hostname === null)
return null;

if (hostname.lastIndexOf('.') == -1)
hostname += ".com";

return hostname;
}

function callback() {
}

function escape_modified_check() {
pc_save(true);
if (UI.obj.cmp(MODIFIED_OBJ_DATA,ORIGINAL_OBJ_DATA))
return false;
else
return true;
}

function to_forgot_pwd() {
displayPopout('parental_controls_forgot_pwd');
}
function reset_pc_password() {
displayPopout('parental_controls_password');
}

function set_obj_success_cb(obj) {
get_info_data(INFO_LIST);
show_alert(L.common.success_title, L.common.save_success);
}
function set_obj_error_cb(obj) {
if (obj.api_return == 403) {
logout('sto')
}
else {
show_alert(L.common.fail_title, L.common.save_fail)
}
}
function set_obj_data(obj_content){
if(typeof(obj_content) == 'string')
API.obj.set(JSON.parse(obj_content), set_obj_success_cb, set_obj_error_cb);
else if(typeof(obj_content) == 'object')
API.obj.set(obj_content, set_obj_success_cb, set_obj_error_cb);
}
function pc_save(fake_action) {
var i,j;
var index=$('#restrict_internet_access').find(":selected").index();

MODIFIED_OBJ_DATA.pc.PcP.enable=$('#parental_enable').prop('checked') ? '1' : '0';

if (index >= 0) {
MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[index].blockType=schedule_type;
MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[index].workdayTimeStart=$('#school_nights_start').val();
MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[index].workdayTimeStop=$('#school_nights_end').val();
MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[index].weekendTimeStart=$('#weekends_start').val();
MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[index].weekendTimeStop=$('#weekends_end').val();
for (j=1; j <= 8; ++j) {
var tmp_url = extractHostname(eval('$("#block_url'+j+'").val()'));

tmp_url = appendTopLevelDomain(tmp_url);

if (typeof(tmp_url) == 'undefined' || tmp_url === null)
tmp_url = "";

eval('$("#block_url'+j+'").val(tmp_url)');
eval('MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT['+index+'].blockUrl'+j+'=tmp_url');
}
}

for (i=0; i < MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT.length; ++i) {
for (j=0; j < ORIGINAL_OBJ_DATA.pcPolicy.PcPolicyT.length; ++j) {
if (MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[i].targetMac == ORIGINAL_OBJ_DATA.pcPolicy.PcPolicyT[j].targetMac)
{
// use gid that we get from object
MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[i].gid=ORIGINAL_OBJ_DATA.pcPolicy.PcPolicyT[j].gid;
break;
}
}
MODIFIED_OBJ_DATA.pcPolicy.PcPolicyT[i].name='PcPolicyT'+i;
}

if (fake_action == true) return;

if (JSON.stringify(MODIFIED_OBJ_DATA) == JSON.stringify(ORIGINAL_OBJ_DATA))
show_alert(L.common.lang_info_title, L.common.lang_config_not_change);
else {
// show dialog: input password
set_obj_data(MODIFIED_OBJ_DATA);
}
}
function page_save(){
if (MODIFIED_OBJ_DATA.pc.PcP.setupPasswd == "" ||
MODIFIED_OBJ_DATA.pc.PcP.setupSecretQuestion == "" ||
MODIFIED_OBJ_DATA.pc.PcP.setupSecretAnswer == "")
// fist time setting password and Q&A
reset_pc_password();
else
// after setting, use password to auth
displayPopout('parental_controls_auth');

return;
}
function page_cancel(){
//Coding cancel function here
MODIFIED_OBJ_DATA = API.obj.copy(ORIGINAL_OBJ_DATA);
set_parental_controls_init(ORIGINAL_OBJ_DATA);
}
function get_obj_success_cb(obj) {
ORIGINAL_OBJ_DATA = API.obj.copy(obj);
MODIFIED_OBJ_DATA = API.obj.copy(ORIGINAL_OBJ_DATA);

set_specific_time_select_opts();

set_parental_controls_init(MODIFIED_OBJ_DATA);
}
function get_obj_error_cb(obj) {
if (obj.api_return == 403) {
logout('sto')
}
}
function get_obj_data(obj_list){
API.obj.get(obj_list, get_obj_success_cb, get_obj_error_cb);
}
function get_info_success_cb(obj) {
INFO_DATA = API.obj.copy(obj);
get_obj_data(OBJ_LIST);
}
function get_info_error_cb(obj) {
if (obj.api_return == 403) {
logout('sto')
}
}
function get_info_data(info_list) {
API.info.get(info_list, get_info_success_cb, get_info_error_cb);
}
function page_initial(){
//Coding initial function here
get_info_data(INFO_LIST);
}


</script>

